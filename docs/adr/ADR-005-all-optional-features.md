# ADR-005: Все «опциональные» фичи ТЗ — обязательны

**Статус:** Принято
**Дата:** 2026-02-19

---

## Контекст

ТЗ содержит секцию «Дополнительно (по желанию, но сильно повышает оценку)»:
1. Поддержка форматирования (жирный, курсив) в сообщениях
2. Уведомление о новых сообщениях в неактивных чатах (точка-индикатор)
3. Простенький адаптив: на мобилке чат во весь экран, в отдельном роуте

## Решение

Все три пункта **реализуются как обязательные** и учитываются в архитектуре с самого начала.

## Влияние на архитектуру

### 1. Форматирование сообщений

- Выделенный модуль `src/utils/textFormatter.ts` — чистая функция без зависимостей от Vue
- Парсинг `**bold**` → `<strong>` и `*italic*` → `<em>` через regex
- Компонент `MessageItem.vue` рендерит через `v-html` (с санитизацией)
- Кнопки форматирования в `MessageInput.vue` (Bold / Italic)
- **Тестируется изолированно** — textFormatter полностью покрывается юнит-тестами

```ts
// src/utils/textFormatter.ts
export function formatMessageText(raw: string): string {
  // Порядок важен: сначала **bold**, потом *italic*
  return raw
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>')
}
```

> ⚠️ `v-html` — санитизация обязательна. Использовать только форматирование, не произвольный HTML.

### 2. Бейдж непрочитанных

- Поле `unreadCount: number` в сущности `Chat` — часть основной модели данных
- `chatsStore.receiveMessage()` учитывает `activeChatId` при инкременте
- `chatsStore.openChat()` сбрасывает `unreadCount` в 0
- `BaseBadge.vue` из UI-кита используется в `ChatListItem.vue`
- Архитектурно: нет отдельного store, данные хранятся в `Chat.unreadCount`

### 3. Адаптивный дизайн

- Два набора роутов в `router/index.ts` (см. Feature F05)
- На `≥ 768px`: `/` → `AppLayout` (два блока рядом)
- На `< 768px`: `/` → `ChatListView`, `/chat/:id` → `ChatView`
- Определение мобильного — composable `useBreakpoint.ts` через `window.matchMedia`
- В `ChatHeader.vue` — кнопка «Назад» для мобильного (видна только на mobile)
- CSS Media queries в SCSS обеспечивают скрытие панелей

## Последствия

- `Chat.unreadCount` и `textFormatter` — часть базовой архитектуры, не добавляются «потом»
- Router настраивается с учётом мобильных роутов с первого дня
- Увеличение объёма примерно на 20–25% по сравнению с базовыми требованиями
